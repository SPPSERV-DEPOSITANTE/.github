name: Zerar Remaining ao mover para Done (Projects v2)

on:
  schedule:
    - cron: '*/5 * * * *' # a cada 5 minutos
  workflow_dispatch: # permite executar manualmente

jobs:
  zerar_remaining:
    runs-on: ubuntu-latest

    steps:
      - name: Instalar GH CLI e jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh

      - name: Autenticar no GitHub CLI
        run: gh auth login --with-token <<< "${{ secrets.GH_PAT }}"

      - name: Zerar campo Remaining para cards em Done
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name || github.repository }}
          PROJECT_NUMBER: 1 # ALTERE se seu projeto for outro
          FIELD_NAME: Remaining
          STATUS_FIELD_NAME: Status
          DONE_VALUE: Done
        run: |
          echo "🔍 Buscando itens do projeto..."
          gh api graphql -F owner="$OWNER" -F repo="$REPO" -F projectNumber=$PROJECT_NUMBER -f query='
            query($owner: String!, $repo: String!, $projectNumber: Int!) {
              repository(owner: $owner, name: $repo) {
                projectV2(number: $projectNumber) {
                  id
                  fields(first: 100) {
                    nodes {
                      ... on ProjectV2FieldCommon {
                        id
                        name
                      }
                    }
                  }
                  items(first: 100) {
                    nodes {
                      id
                      content {
                        ... on Issue {
                          number
                          title
                        }
                      }
                      fieldValues(first: 20) {
                        nodes {
                          ... on ProjectV2ItemFieldSingleSelectValue {
                            name
                            field {
                              ... on ProjectV2FieldCommon {
                                id
                                name
                              }
                            }
                          }
                          ... on ProjectV2ItemFieldNumberValue {
                            number
                            field {
                              ... on ProjectV2FieldCommon {
                                id
                                name
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }' > result.json

          PROJECT_ID=$(jq -r '.data.repository.projectV2.id' result.json)
          REMAINING_FIELD_ID=$(jq -r --arg FN "$FIELD_NAME" '.data.repository.projectV2.fields.nodes[] | select(.name == $FN) | .id' result.json)

          jq -c '.data.repository.projectV2.items.nodes[]' result.json | while read -r item; do
            ITEM_ID=$(echo "$item" | jq -r '.id')
            TITLE=$(echo "$item" | jq -r '.content.title // "Sem título"')
            STATUS=$(echo "$item" | jq -r --arg SF "$STATUS_FIELD_NAME" '.fieldValues.nodes[] | select(.field.name == $SF) | .name')
            REMAINING=$(echo "$item" | jq -r --arg FN "$FIELD_NAME" '.fieldValues.nodes[] | select(.field.name == $FN) | .number // empty')

            if [[ "$STATUS" == "$DONE_VALUE" && "$REMAINING" != "0" && "$REMAINING" != "" ]]; then
              echo "🛠️ ZERANDO 'Remaining' para: $TITLE"
              gh api graphql -f query='
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId,
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: { number: 0 }
                  }) {
                    projectV2Item {
                      id
                    }
                  }
                }' \
              -F projectId=$PROJECT_ID \
              -F itemId=$ITEM_ID \
              -F fieldId=$REMAINING_FIELD_ID > /dev/null
            fi
          done
